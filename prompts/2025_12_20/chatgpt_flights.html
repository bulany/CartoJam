<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Flight Route Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    margin: 0;
    overflow: hidden;
    background: black;
    font-family: "Courier New", monospace;
    color: #0f0;
}
.panel {
    position: absolute;
    background: rgba(0,20,0,0.85);
    border: 1px solid #0f0;
    padding: 12px;
    z-index: 10;
}
#input-panel { top: 20px; left: 20px; width: 260px; }
#timeline-panel { bottom: 30px; left: 50%; transform: translateX(-50%); width: 60%; display: none; }
input, button {
    width: 100%;
    margin-top: 6px;
    background: black;
    color: #0f0;
    border: 1px solid #0f0;
    padding: 6px;
}
button {
    background: #0f0;
    color: black;
    font-weight: bold;
    cursor: pointer;
}
button.secondary {
    background: transparent;
    color: #0f0;
}
input[type=range] { accent-color: #0f0; }
#crt {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background:
        linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.25) 50%),
        radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.5) 100%);
    background-size: 100% 3px, 100% 100%;
}
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>
<body>

<div id="crt"></div>

<div id="input-panel" class="panel">
    <div>Airport Codes</div>
    <input id="codes" placeholder="JFK, CDG, LHR">
    <button id="init">INITIALIZE ROUTE</button>
    <button id="reset" class="secondary">RESET ROUTE</button>
    <button id="share" class="secondary">COPY SHARE LINK</button>
</div>

<div id="timeline-panel" class="panel">
    <input type="range" id="scrubber" min="0" max="1000" value="0">
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";

const GLOBE_RADIUS = 20;
const SPEED_KMPH = 900;
let AIRPORTS = {}

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(40,30,50);

const renderer = new THREE.WebGLRenderer({antialias:false});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.autoRotate = true;

const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
composer.addPass(new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 1.5, 0.4, 0.85));

function latLonToVec(lat, lon, r) {
    const phi = (90-lat)*Math.PI/180;
    const theta = (lon+180)*Math.PI/180;
    return new THREE.Vector3(
        -r*Math.sin(phi)*Math.cos(theta),
        r*Math.cos(phi),
        r*Math.sin(phi)*Math.sin(theta)
    );
}

function greatCirclePoints(a, b, steps=64) {
    const pts=[];
    for(let i=0;i<=steps;i++){
        const v=a.clone().lerp(b,i/steps).normalize().multiplyScalar(GLOBE_RADIUS);
        pts.push(v);
    }
    return pts;
}

let routePoints=[];
let routeLengths=[];
let totalDistance=0;

const dot = new THREE.Mesh(
    new THREE.SphereGeometry(0.4,8,8),
    new THREE.MeshBasicMaterial({color:0xffffff})
);
scene.add(dot);

async function loadGlobe() {
    const res = await fetch("./ne_110m_coastline.geojson");
    const data = await res.json();
    const pts=[];
    data.features.forEach(f=>{
        const lines = f.geometry.type==="LineString" ? [f.geometry.coordinates] : f.geometry.coordinates;
        lines.forEach(l=>{
            for(let i=0;i<l.length-1;i++){
                pts.push(
                    latLonToVec(l[i][1],l[i][0],GLOBE_RADIUS),
                    latLonToVec(l[i+1][1],l[i+1][0],GLOBE_RADIUS)
                );
            }
        });
    });
    scene.add(new THREE.LineSegments(
        new THREE.BufferGeometry().setFromPoints(pts),
        new THREE.LineBasicMaterial({ color: 0x00ff22 })
    ));
    scene.add(new THREE.Mesh(
        new THREE.SphereGeometry(GLOBE_RADIUS*0.98,32,32),
        new THREE.MeshBasicMaterial({ color:0x000500, transparent: true, opacity: 0.9})
    ));
}

async function loadAirports() {
    const res = await fetch("./airports.json");
    const data = await res.json();
    AIRPORTS = data;
    window.AIRPORTS = AIRPORTS
}

function resetRoute() {
    routePoints=[];
    routeLengths=[];
    totalDistance=0;
    dot.visible=false;
    document.getElementById("timeline-panel").style.display="none";
}

function initRoute(codes) {
    resetRoute();
    const list = codes.map(c=>c.trim().toUpperCase()).filter(c=>AIRPORTS[c]);
    for(let i=0;i<list.length-1;i++){
        const a=AIRPORTS[list[i]];
        const b=AIRPORTS[list[i+1]];
        console.log('a1', a);
        const v1=latLonToVec(a.lat,a.lon,GLOBE_RADIUS);
        const v2=latLonToVec(b.lat,b.lon,GLOBE_RADIUS);
        const pts=greatCirclePoints(v1,v2);
        const geo=new THREE.BufferGeometry().setFromPoints(pts);
        scene.add(new THREE.Line(geo,new THREE.LineBasicMaterial({color:0x00ffaa})));
        const dist=v1.angleTo(v2)*6371;
        routePoints.push(pts);
        routeLengths.push(dist);
        totalDistance+=dist;
        console.log('dist', totalDistance)
    }
    dot.visible=true;
    document.getElementById("timeline-panel").style.display="block";
}

document.getElementById("init").onclick=()=>{
    const codes=document.getElementById("codes").value.split(",");
    initRoute(codes);
    location.hash=codes.join(",");
};

document.getElementById("reset").onclick=()=>{
    resetRoute();
    history.replaceState(null,"",location.pathname);
};

document.getElementById("share").onclick=()=>{
    navigator.clipboard.writeText(location.href);
};

document.getElementById("scrubber").oninput=e=>{
    let t=e.target.value/1000;
    let d=t*totalDistance;
    for(let i=0;i<routePoints.length;i++){
        if(d<=routeLengths[i]){
            const local=d/routeLengths[i];
            const idx=Math.floor(local*(routePoints[i].length-1));
            dot.position.copy(routePoints[i][idx]);
            break;
        }
        d-=routeLengths[i];
    }
};

loadGlobe();
loadAirports();

if(location.hash){
    const c=location.hash.substring(1).split(",");
    document.getElementById("codes").value=c.join(", ");
    initRoute(c);
}

function animate(){
    requestAnimationFrame(animate);
    controls.update();
    composer.render();
}
animate();

window.onresize=()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
    composer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>
